
# ä¸€ã€ç°æœ‰ `portal` server ä¸­åŠ å…¥ã€Œå¯æ‰©å±•æ³¨é‡Šã€

> ç›®æ ‡ï¼š
>
> * **ç°åœ¨åªå¯ PAP / SQLï¼Œ100% å¯è·‘**
> * **æœªæ¥å¯ç”¨ EAP æ—¶ï¼Œåªæ˜¯â€œè§£æ³¨é‡Š + å¯æ¨¡å—â€**

---

## `sites-enabled/portal`ï¼ˆå¢å¼ºæ³¨é‡Šç‰ˆï¼‰

```conf
server portal {

    ####################################################################
    # Portal / PAP / SQL è®¤è¯æœåŠ¡
    #
    # è®¾è®¡ç›®æ ‡ï¼š
    # 1. å½“å‰é˜¶æ®µï¼šPortal / HTTP ç™»å½• â†’ RADIUS PAP
    # 2. åç»­é˜¶æ®µï¼šåŒä¸€å¥— SQL / ç”¨æˆ·ä½“ç³»ï¼Œæ‰©å±•åˆ° 802.1X / WPA-Enterprise
    #
    # âš  æ³¨æ„ï¼š
    # - å½“å‰æœªå¯ç”¨ EAP
    # - æœªåŠ è½½ inner-tunnel
    # - æœ¬ server ä¸é€‚ç”¨äº 802.1X
    ####################################################################

    listen {
        type   = auth
        ipaddr = *
        port   = 1812
    }

    ####################################################################
    # authorize é˜¶æ®µ
    ####################################################################
    authorize {

        preprocess

        # ------------------------------
        # PAP / Portal ç™»å½•
        # ------------------------------
        #
        # Portal åœºæ™¯ä¸‹ï¼ŒUser-Password ç”±ï¼š
        #   - Web Portal
        #   - Controller
        #   - NAS
        # æ˜æ–‡æˆ–å¯é€†æ–¹å¼é€å…¥ RADIUS
        #
        chap
        mschap

        # ------------------------------
        # SQLï¼šåŠ è½½ç”¨æˆ·å‡­æ®
        # ------------------------------
        #
        # å¿…é¡»åœ¨è¿™é‡ŒåŠ è½½ Cleartext-Password
        # ä¾‹å¦‚ï¼š
        #   radcheck.value = æ˜æ–‡å¯†ç  / hash
        #
        sql

        # ------------------------------
        # å¦‚æœ SQL ä¸­æ²¡æœ‰å¯†ç  â†’ ç›´æ¥æ‹’ç»
        # ------------------------------
        if (!control:Cleartext-Password) {
            reject
        }

        # ------------------------------
        # æ˜ç¡®æŒ‡å®š Auth-Type
        # ------------------------------
        update control {
            Auth-Type := PAP
        }

        ################################################################
        # ã€æœªæ¥æ‰©å±•ç‚¹ã€‘802.1X / WPA-Enterprise
        #
        # å½“å¯ç”¨ EAP åï¼š
        #
        # - supplicant ä¼šå‘é€ EAP-Message
        # - FreeRADIUS ä¼šèµ° eap æ¨¡å—
        #
        # if (EAP-Message) {
        #     eap
        # }
        #
        ################################################################
    }

    ####################################################################
    # authenticate é˜¶æ®µ
    ####################################################################
    authenticate {

        # ------------------------------
        # PAPï¼ˆPortal / é 802.1Xï¼‰
        # ------------------------------
        Auth-Type PAP {
            pap
        }

        ################################################################
        # ã€æœªæ¥æ‰©å±•ç‚¹ã€‘EAP
        #
        # Auth-Type EAP {
        #     eap
        # }
        #
        ################################################################
    }

    ####################################################################
    # post-auth é˜¶æ®µ
    ####################################################################
    post-auth {

        # ------------------------------
        # è®°å½•è®¤è¯ç»“æœ
        # ------------------------------
        sql

        ################################################################
        # ã€æœªæ¥æ‰©å±•ç‚¹ã€‘
        # - VLAN ä¸‹å‘
        # - Filter-Id
        # - QoS / ACL
        ################################################################
    }

    ####################################################################
    # accounting é˜¶æ®µ
    ####################################################################
    accounting {
        sql
    }
}
```

ğŸ‘‰ **ç°åœ¨å¯ä»¥ç›´æ¥ç”¨ï¼Œæœªæ¥åªæ˜¯â€œè§£æ³¨é‡Š + åŠ æ¨¡å—â€**

---

# äºŒã€æœªæ¥å¯ç”¨ 802.1X / WPA-Enterprise æ—¶ï¼Œéœ€è¦åšä»€ä¹ˆï¼Ÿ

ä¸‹é¢æ˜¯**ä¸¥æ ¼æŒ‰â€œæœ€å°ä¾µå…¥â€é¡ºåº**çš„ checklistã€‚

---

## â‘  å¯ç”¨æ¨¡å—ï¼ˆDockerfile å±‚ï¼‰

```dockerfile
# å¯ç”¨ EAP / inner-tunnel
RUN ln -s ../mods-available/eap /opt/etc/raddb/mods-enabled/eap \
 && ln -s ../sites-available/inner-tunnel /opt/etc/raddb/sites-enabled/inner-tunnel
```

> âš  ä¸è¦å’Œ portal server æ··åœ¨ä¸€èµ·
> inner-tunnel æ˜¯ **EAP ä¸“ç”¨**

---

## â‘¡ æ–°å¢ä¸€ä¸ª serverï¼š`sites-enabled/wpa-enterprise`

**ä¸è¦å¤ç”¨ `portal`**

```conf
server wpa-enterprise {

    listen {
        type = auth
        ipaddr = *
        port = 1812
    }

    authorize {
        preprocess
        eap
    }

    authenticate {
        eap
    }

    post-auth {
        sql
    }
}
```

---

## â‘¢ `mods-enabled/eap`ï¼ˆå…³é”®æ€æƒ³ï¼‰

* **EAP åªè´Ÿè´£éš§é“**
* **çœŸæ­£æŸ¥å¯†ç çš„åœ°æ–¹ä»ç„¶æ˜¯ SQL**
* **inner-tunnel æ‰æ˜¯â€œçœŸæ­£çš„è®¤è¯ serverâ€**

inner-tunnel é‡Œä½ ä¼šçœ‹åˆ°ç†Ÿæ‚‰çš„é€»è¾‘ï¼š

```conf
authorize {
    sql
    if (!control:Cleartext-Password) {
        reject
    }
}
```

ğŸ‘‰ **Portal / WPA-Enterprise å…±ç”¨ä¸€å¥—ç”¨æˆ·åº“**

---

# ä¸‰ã€Portal â†” 802.1X å…±å­˜çš„æ¨èæ¼”è¿›æ¨¡å‹ï¼ˆé‡ç‚¹ï¼‰

è¿™æ˜¯**ç”Ÿäº§ç³»ç»Ÿé‡Œæœ€ç¨³çš„ç»“æ„**ï¼š

```
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚   SQL DB    â”‚
                â”‚ users / pw  â”‚
                â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ server portal  â”‚          â”‚ server wpa-enterp. â”‚
â”‚ PAP / HTTP     â”‚          â”‚ EAP / 802.1X       â”‚
â”‚ Captive Portal â”‚          â”‚ WPA2/WPA3-Enterpriseâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                 â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
                                 â”‚ inner-tunnelâ”‚
                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¸ºä»€ä¹ˆè¿™æ˜¯æœ€ä¼˜è§£ï¼Ÿ

| é—®é¢˜                 | è¿™æ ·åšçš„å¥½å¤„ |
| ------------------ | ------ |
| Portal å’Œ 802.1X æ··æ‚ | âŒ é¿å…   |
| EAP å¤æ‚åº¦æ±¡æŸ“ Portal   | âŒ é¿å…   |
| ç”¨æˆ·ç³»ç»Ÿé‡å¤             | âŒ é¿å…   |
| è¿ç»´é£é™©               | âœ… æœ€å°   |

---

# å››ã€ä½ ç°åœ¨çš„ç³»ç»Ÿå·²ç»å…·å¤‡çš„â€œEnterprise åŸºç¡€èƒ½åŠ›â€

ä½ å¯èƒ½æ²¡æ„è¯†åˆ°ï¼Œä½†ä½ å·²ç»æœ‰äº†ï¼š

* âœ… SQL ç”¨æˆ·åº“ï¼ˆradcheck / radreplyï¼‰
* âœ… Controller / Portal ç»Ÿä¸€è®¤è¯å…¥å£
* âœ… å¯æ‰©å±•çš„ RADIUS å®¹å™¨åŒ–éƒ¨ç½²
* âœ… å¯æ’æ‹”çš„è®¤è¯ server ç»“æ„

**ç¼ºçš„åªæ˜¯ï¼š**

* eap
* inner-tunnel
* ä¸€ä¸ªæ–°çš„ server æ–‡ä»¶

ğŸ‘‰ **è¿™æ˜¯â€œåŠ åŠŸèƒ½â€ï¼Œä¸æ˜¯â€œæ¨å€’é‡æ¥â€**

---

# äº”ã€åç»­

1. **â€œPortal + WPA-Enterprise å…±ç”¨ SQLâ€çš„å®Œæ•´ raddb ç›®å½•æ ‘**
2. **ç¡®å®š radcheck / radreply è®¾è®¡è§„èŒƒï¼ˆPortal / 802.1X é€šç”¨ï¼‰**
3. **ç»“åˆ AP / AC æ¶æ„ï¼Œè®¾è®¡ VLAN / ACL / Role ä¸‹å‘æ–¹æ¡ˆ**

