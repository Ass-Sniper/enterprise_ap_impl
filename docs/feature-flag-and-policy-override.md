
# FeatureFlag ä¸ ç”¨æˆ·ç­–ç•¥è¦†ç›–ï¼ˆPolicy Overrideï¼‰çš„å®é™…æ„ä¹‰

> æœ¬æ–‡æ¡£ç”¨äºè¯´æ˜åœ¨ Portal / NAC ç³»ç»Ÿä¸­
> **FeatureFlag** ä¸ **ç”¨æˆ·ç­–ç•¥è¦†ç›–ï¼ˆpolicy:user:*ï¼‰**
> å„è‡ªè§£å†³ä»€ä¹ˆé—®é¢˜ã€ä»€ä¹ˆæ—¶å€™ä½¿ç”¨ã€ä»¥åŠå®ƒä»¬å¦‚ä½•ååŒå·¥ä½œã€‚

---

## ä¸€ã€æ•´ä½“å®šä½ï¼ˆä¸€å¥è¯ç‰ˆï¼‰

* **FeatureFlag**ï¼š
  ğŸ‘‰ *â€œè¿™ä¸ªèƒ½åŠ›ç°åœ¨æ˜¯å¦å…è®¸è¢«ä½¿ç”¨ï¼Ÿâ€*

* **ç”¨æˆ·ç­–ç•¥è¦†ç›–ï¼ˆPolicy Overrideï¼‰**ï¼š
  ğŸ‘‰ *â€œè¿™ä¸ªç”¨æˆ·/è®¾å¤‡æ˜¯å¦éœ€è¦ä¸€ä¸ªä¾‹å¤–çš„å‡†å…¥è§„åˆ™ï¼Ÿâ€*

äºŒè€…è§£å†³çš„é—®é¢˜ä¸åŒï¼Œä½†**å¿…é¡»åŒæ—¶å­˜åœ¨**ï¼Œå¦åˆ™ç³»ç»Ÿè¦ä¹ˆä¸çµæ´»ï¼Œè¦ä¹ˆä¸å¯æ§ã€‚

---

## äºŒã€ä¸ºä»€ä¹ˆéœ€è¦ FeatureFlagï¼Ÿ

### 1ï¸âƒ£ FeatureFlag è§£å†³çš„é—®é¢˜æœ¬è´¨

> **FeatureFlag çš„æ ¸å¿ƒæ„ä¹‰ï¼š
> åœ¨ä¸æ”¹ä»£ç ã€ä¸æ”¹ç­–ç•¥ã€ä¸é‡å¯æœåŠ¡çš„æƒ…å†µä¸‹ï¼Œ
> åŠ¨æ€æ§åˆ¶æŸä¸ªâ€œè®¤è¯èƒ½åŠ› / åŠŸèƒ½æ¨¡å—â€æ˜¯å¦å¯ç”¨ã€‚**

å®ƒå…³æ³¨çš„æ˜¯ï¼š**â€œèƒ½åŠ›æ˜¯å¦å¼€æ”¾â€**ï¼Œè€Œä¸æ˜¯â€œè°èƒ½ç”¨â€ã€‚

---

### 2ï¸âƒ£ æ²¡æœ‰ FeatureFlag ä¼šæ€æ ·ï¼Ÿ

å‡è®¾ç³»ç»Ÿæ²¡æœ‰ FeatureFlagï¼š

| éœ€æ±‚            | ä½ ä¼šè¢«è¿«åšçš„äº‹   |
| ------------- | --------- |
| ä¸´æ—¶å…³é—­ SMS ç™»å½•   | æ”¹ä»£ç  / æ”¹ç­–ç•¥ |
| ç°åº¦å¼€æ”¾ token ç™»å½• | æ–°å»ºç­–ç•¥      |
| ç´§æ€¥å›æ»šæ–°è®¤è¯æ–¹å¼     | å›æ»šç‰ˆæœ¬      |
| æ§åˆ¶æ–°åŠŸèƒ½é£é™©       | æ— èƒ½ä¸ºåŠ›      |

ğŸ‘‰ **èƒ½åŠ›æ§åˆ¶å’Œç”¨æˆ·ç­–ç•¥å®Œå…¨è€¦åˆï¼Œé£é™©æé«˜ã€‚**

---

### 3ï¸âƒ£ FeatureFlag çš„å…¸å‹ä½¿ç”¨åœºæ™¯

#### âœ… åœºæ™¯ Aï¼šèƒ½åŠ›çº§å¼€å…³

```text
feature:auth:pap = 1
feature:auth:sms = 0
```

* pap å¯ä»¥ç”¨
* sms è¢«å…¨å±€å…³é—­
* policy.yaml ä¸éœ€è¦æ”¹

---

#### âœ… åœºæ™¯ Bï¼šç”¨æˆ·ç°åº¦

```text
feature:auth:sms:user:testuser = 1
```

* åªå…è®¸ testuser ä½¿ç”¨ sms
* å…¶ä»–ç”¨æˆ·ä»ç„¶è¢«æ‹¦æˆª

---

#### âœ… åœºæ™¯ Cï¼šç´§æ€¥æ­¢è¡€

```text
DEL feature:auth:pap
```

* æ‰€æœ‰ pap ç™»å½•ç«‹åˆ»è¢«æ‹’ç»
* ä¸ä¾èµ–å‘å¸ƒæµç¨‹

---

### 4ï¸âƒ£ FeatureFlag çš„è¾¹ç•Œï¼ˆå¾ˆé‡è¦ï¼‰

âŒ FeatureFlag **ä¸åº”è¯¥**ï¼š

* å†³å®šä¼šè¯æ—¶é•¿
* å†³å®šè½åœ°é¡µ
* å†³å®šç”¨æˆ·è§’è‰²
* è¡¨è¾¾ä¸šåŠ¡ç­–ç•¥

ğŸ‘‰ å®ƒåªå›ç­”ä¸€ä¸ªé—®é¢˜ï¼š**â€œè¿™ä¸ªèƒ½åŠ›ç°åœ¨å¼€æ²¡å¼€ï¼Ÿâ€**

---

## ä¸‰ã€ä¸ºä»€ä¹ˆéœ€è¦ç”¨æˆ·ç­–ç•¥è¦†ç›–ï¼ˆPolicy Overrideï¼‰ï¼Ÿ

### 1ï¸âƒ£ ç”¨æˆ·ç­–ç•¥è¦†ç›–è§£å†³çš„é—®é¢˜æœ¬è´¨

> **ç”¨æˆ·ç­–ç•¥è¦†ç›–çš„æ ¸å¿ƒæ„ä¹‰ï¼š
> åœ¨ä¸æ±¡æŸ“å…¨å±€ç­–ç•¥ã€ä¸å½±å“å…¶ä»–ç”¨æˆ·çš„å‰æä¸‹ï¼Œ
> ä¸ºâ€œæŸä¸€ä¸ªç”¨æˆ· / è®¾å¤‡â€æä¾›ä¾‹å¤–å‡†å…¥è¡Œä¸ºã€‚**

å®ƒå…³æ³¨çš„æ˜¯ï¼š**â€œè¿™ä¸ªå¯¹è±¡æ˜¯ä¸æ˜¯ç‰¹æ®Šæƒ…å†µï¼Ÿâ€**

---

### 2ï¸âƒ£ æ²¡æœ‰ç”¨æˆ·ç­–ç•¥è¦†ç›–ä¼šæ€æ ·ï¼Ÿ

å¦‚æœç³»ç»Ÿåªæœ‰ `policy.yaml`ï¼š

| éœ€æ±‚              | ä½ ä¼šè¢«è¿«åšçš„äº‹   |
| --------------- | --------- |
| å•ä¸ªç”¨æˆ·ä¸´æ—¶æ”¾è¡Œ        | æ”¹å…¨å±€ç­–ç•¥     |
| VIP ä½¿ç”¨ç‰¹æ®Šè·³è½¬é¡µ     | æ–°å»º policy |
| è¿ç»´/ç®¡ç†å‘˜ä¸èµ° Portal | å†™ if else |
| æµ‹è¯•æ–°ç­–ç•¥           | æ–°ç¯å¢ƒ       |

ğŸ‘‰ **ä½ ä¼šä¸æ–­æ±¡æŸ“å…¨å±€é…ç½®ï¼Œç³»ç»Ÿè¶Šæ¥è¶Šä¸å¯æ§ã€‚**

---

### 3ï¸âƒ£ ç”¨æˆ·ç­–ç•¥è¦†ç›–çš„å…¸å‹ä½¿ç”¨åœºæ™¯

#### âœ… åœºæ™¯ Aï¼šVIP / ç®¡ç†å‘˜

```redis
policy:user:admin = {
  "name": "admin-override",
  "allowed": ["token"],
  "sessionTimeout": 86400,
  "redirectURL": "https://intranet.example.com"
}
```

* ä¸å½±å“æ™®é€šå‘˜å·¥
* ä¸æ”¹ policy.yaml
* å³æ—¶ç”Ÿæ•ˆ

---

#### âœ… åœºæ™¯ Bï¼šç°åœºæ•‘ç« / æŠ•è¯‰å¤„ç†

```redis
policy:user:testuser = {
  "allowed": ["pap"],
  "sessionTimeout": 600
}
```

* ä¸´æ—¶ç”Ÿæ•ˆ
* é—®é¢˜ä¿®å®Œå³å¯åˆ é™¤

---

#### âœ… åœºæ™¯ Cï¼šç°åº¦ / AB æµ‹è¯•

```redis
policy:user:userA = { "allowed": ["sms"] }
policy:user:userB = { "allowed": ["sms"] }
```

ğŸ‘‰ ä¸éœ€è¦æ–°å»ºå…¨å±€ç­–ç•¥ã€‚

---

### 4ï¸âƒ£ ç”¨æˆ·ç­–ç•¥è¦†ç›–çš„è¾¹ç•Œ

âŒ ä¸åº”è¯¥ï¼š

* é•¿æœŸæ›¿ä»£ policy.yaml
* ç”¨æ¥æè¿°ç”¨æˆ·è§’è‰²
* ä¿å­˜å¤æ‚ä¸šåŠ¡é€»è¾‘
* æ— é™å †ç§¯ï¼ˆåº”å‡çº§ä¸ºæ­£å¼ç­–ç•¥ï¼‰

ğŸ‘‰ **å®ƒæ˜¯â€œä¾‹å¤–é€šé“â€ï¼Œä¸æ˜¯ä¸»å¹²é…ç½®ã€‚**

---

## å››ã€FeatureFlag vs ç”¨æˆ·ç­–ç•¥è¦†ç›–ï¼ˆå¯¹ç…§è¡¨ï¼‰

| ç»´åº¦       | FeatureFlag | ç”¨æˆ·ç­–ç•¥è¦†ç›–  |
| -------- | ----------- | ------- |
| æ§åˆ¶å¯¹è±¡     | åŠŸèƒ½ / èƒ½åŠ›     | ç”¨æˆ· / è®¾å¤‡ |
| å›ç­”çš„é—®é¢˜    | èƒ½ä¸èƒ½ç”¨        | æ€ä¹ˆç”¨     |
| æ˜¯å¦å½±å“æ‰€æœ‰ç”¨æˆ· | æ˜¯           | å¦       |
| ç”Ÿå‘½å‘¨æœŸ     | ä¸­ / é•¿æœŸ      | çŸ­ / ä¸­æœŸ  |
| æ˜¯å¦å‚ä¸ç­–ç•¥å†³ç­– | å¦ï¼ˆåª gateï¼‰   | æ˜¯       |
| æ˜¯å¦å¯ç°åº¦    | âœ…           | âœ…       |
| æ˜¯å¦åº”å¸¸é©»    | âœ…           | âŒ       |

---

## äº”ã€åœ¨ Portal / NAC æ¶æ„ä¸­çš„åä½œå…³ç³»

ä½ ç°åœ¨ç³»ç»Ÿçš„å†³ç­–é“¾è·¯ï¼ˆéå¸¸æ­£ç¡®ï¼‰æ˜¯ï¼š

```
FeatureFlagï¼ˆèƒ½åŠ›æ˜¯å¦å¼€æ”¾ï¼‰
        â†“
Policy Overrideï¼ˆæ˜¯å¦æœ‰ç”¨æˆ·ä¾‹å¤–ï¼‰
        â†“
Policy.yaml / RADIUS Hintï¼ˆæ­£å¼ç­–ç•¥ï¼‰
        â†“
Strategyï¼ˆpap / sms / tokenï¼‰
        â†“
RADIUS / Auth Backend
```

### è¿™ä¸ªé¡ºåºçš„æ„ä¹‰ï¼š

* **FeatureFlag**ï¼šå…ˆæŒ¡é£é™©
* **Policy Override**ï¼šå†å¤„ç†ä¾‹å¤–
* **Policy.yaml**ï¼šæœ€åèµ°å¸¸è§„è§„åˆ™

---

## å…­ã€ä¸€ä¸ªå®Œæ•´çš„ç°å®ä¾‹å­

> â€œtestuser èƒ½å¦ç”¨ pap ç™»å½•ï¼Ÿâ€

1. FeatureFlagï¼š

   ```text
   feature:auth:pap = 1
   ```

   â†’ èƒ½åŠ›å¼€æ”¾

2. ç”¨æˆ·ç­–ç•¥è¦†ç›–ï¼š

   ```text
   policy:user:testuser = ä¸å­˜åœ¨
   ```

   â†’ æ— ä¾‹å¤–

3. policy.yamlï¼š

   ```yaml
   allowed: ["pap"]
   ```

   â†’ ç­–ç•¥å…è®¸

4. Strategyï¼š
   â†’ pap

5. RADIUSï¼š
   â†’ æ¥ç®¡è®¤è¯

**ä»»ä½•ä¸€å±‚ denyï¼Œéƒ½ä¼šæ˜ç¡®å¯å®šä½ã€‚**

---

## ä¸ƒã€è®¾è®¡æ€»ç»“ï¼ˆå·¥ç¨‹çº§ï¼‰

> **FeatureFlag è®©ç³»ç»Ÿâ€œæ•¢ä¸Šçº¿â€
> ç”¨æˆ·ç­–ç•¥è¦†ç›–è®©ç³»ç»Ÿâ€œèƒ½æ•‘ç«â€**

äºŒè€…ç»“åˆï¼Œç³»ç»Ÿæ‰èƒ½ä»ï¼š

* èƒ½è·‘
  â†’ èƒ½ç”¨
  â†’ **å¯è¿ç»´ã€å¯ç°åº¦ã€å¯åº”æ€¥**

---

## å…«ã€æ¨èåç»­å¢å¼ºï¼ˆå¯é€‰ï¼‰

* ç»™ `policy:user:*` å¢åŠ  TTL / audit
* æä¾› `/debug/policy?user=` API
* æä¾› `/debug/feature` å¯è§†åŒ–æ¥å£
* æ‰©å±•åˆ° `policy:mac:* / policy:nas:*`

---

