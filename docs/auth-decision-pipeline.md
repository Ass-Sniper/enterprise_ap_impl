
# ä¸€ã€è®¤è¯ä¸ç­–ç•¥å†³ç­–æ€»æµç¨‹å›¾ï¼ˆMermaidï¼‰

> **ç”¨é€”**
>
> * æ’éšœï¼ˆä¸ºä»€ä¹ˆè¢«æ‹’ç»ï¼‰
> * è®¾è®¡è¯„å®¡ï¼ˆæ¯ä¸€å±‚èŒè´£æ˜¯å¦æ¸…æ™°ï¼‰
> * ç»™åæ¥çš„äººçœ‹ï¼ˆé¿å…â€œæ‹è„‘è¢‹æ”¹é€»è¾‘â€ï¼‰

```mermaid
flowchart TD
    A[Portal UI æäº¤è®¤è¯è¯·æ±‚] --> B[Access Device / NAC æ¥æ”¶è¯·æ±‚]

    B --> C[è§£æ AuthRequest<br/>username / password / token / user_ip]

    C --> D{FeatureFlag<br/>è¯¥è®¤è¯æ–¹å¼æ˜¯å¦å¼€æ”¾?}

    D -- å¦ --> D1[æ‹’ç»è®¤è¯<br/>err=è¯¥è®¤è¯æ–¹å¼å°šæœªå¼€æ”¾]
    D1 --> Z[è¿”å› Portal UI]

    D -- æ˜¯ --> E{Policy Override<br/>æ˜¯å¦å­˜åœ¨ç”¨æˆ·ç­–ç•¥è¦†ç›–?}

    E -- æ˜¯ --> E1[ä½¿ç”¨ policy:user:*<br/>æ ‡è®° Source=override]
    E -- å¦ --> F{RADIUS Reply Hint<br/>æ˜¯å¦æŒ‡å®šç­–ç•¥?}

    F -- æ˜¯ --> F1[ä½¿ç”¨ RADIUS Hint ç­–ç•¥<br/>Source=radius]
    F -- å¦ --> G[ä½¿ç”¨ policy.yaml é»˜è®¤ç­–ç•¥<br/>Source=default]

    E1 --> H
    F1 --> H
    G --> H

    H{Policy æ˜¯å¦å…è®¸è¯¥è®¤è¯æ–¹å¼?}

    H -- å¦ --> H1[æ‹’ç»è®¤è¯<br/>err=ç­–ç•¥ä¸å…è®¸]
    H1 --> Z

    H -- æ˜¯ --> I[æ„å»º Strategy<br/>pap / sms / token]

    I --> J[æ‰§è¡Œ Authenticate<br/>RADIUS / Backend]

    J -- å¤±è´¥ --> J1[è®¤è¯å¤±è´¥<br/>REJECT / ERROR]
    J1 --> Z

    J -- æˆåŠŸ --> K[åˆ›å»º Session<br/>TTL / Policy / Strategy]

    K --> L[å†³ç­– RedirectURL<br/>req â†’ policy â†’ default]

    L --> M[è¿”å› AuthResponse<br/>success=true]

    M --> Z[Portal UI å±•ç¤ºç»“æœ/è·³è½¬]
```

---

# äºŒã€æ¯ä¸€å±‚â€œä¸ºä»€ä¹ˆå­˜åœ¨â€ï¼ˆç®€æ˜ç‰ˆï¼‰

## â‘  FeatureFlagï¼ˆèƒ½åŠ›çº§ Gateï¼‰

```text
ç›®çš„ï¼šæ§åˆ¶â€œè¿™ä¸ªèƒ½åŠ›ç°åœ¨èƒ½ä¸èƒ½ç”¨â€
```

* ä¸å…³å¿ƒç”¨æˆ·æ˜¯è°
* ä¸å…³å¿ƒç­–ç•¥å†…å®¹
* åªè´Ÿè´£ **æ­¢è¡€ / ç°åº¦ / å¼€å…³**

ğŸ“Œ **æœ€å…ˆæ‰§è¡Œï¼Œæœ€å…ˆæ‹’ç»**

---

## â‘¡ Policy Overrideï¼ˆä¾‹å¤–å±‚ï¼‰

```text
ç›®çš„ï¼šå¤„ç†â€œè¿™ä¸ªç”¨æˆ·æ˜¯ä¸æ˜¯ç‰¹æ®Šæƒ…å†µâ€
```

* ç²¾ç¡®åˆ°ç”¨æˆ· / è®¾å¤‡
* å³æ—¶ç”Ÿæ•ˆ
* ä¸æ±¡æŸ“å…¨å±€ç­–ç•¥

ğŸ“Œ **åªå¤„ç†ä¾‹å¤–ï¼Œä¸æ›¿ä»£ä¸»ç­–ç•¥**

---

## â‘¢ RADIUS Reply Hintï¼ˆå¤–éƒ¨ç­–ç•¥è¾“å…¥ï¼‰

```text
ç›®çš„ï¼šå…è®¸ AAA ç³»ç»Ÿåå‘å½±å“å‡†å…¥ç­–ç•¥
```

* Filter-Id / Reply-Message
* å¸¸ç”¨äºä¼ä¸šåŸŸ / å‘˜å·¥åˆ†ç±»

ğŸ“Œ **å¤–éƒ¨ç³»ç»Ÿä¼˜å…ˆäºæœ¬åœ° YAML**

---

## â‘£ policy.yamlï¼ˆä¸»å¹²ç­–ç•¥ï¼‰

```text
ç›®çš„ï¼šç¨³å®šã€é•¿æœŸã€å¯å®¡è®¡çš„ä¸»ç­–ç•¥
```

* allowed / defaultStrategy
* sessionTimeout / idleTimeout
* redirectURL

ğŸ“Œ **è¿™æ˜¯â€œæ­£å¸¸ç”¨æˆ·â€çš„ä¸–ç•Œ**

---

## â‘¤ Strategyï¼ˆæ‰§è¡Œå±‚ï¼‰

```text
ç›®çš„ï¼šçœŸæ­£å®Œæˆè®¤è¯
```

* pap â†’ RADIUS
* sms â†’ çŸ­ä¿¡å¹³å°
* token â†’ SSO / JWT

ğŸ“Œ **å‰é¢éƒ½é€šè¿‡äº†ï¼Œæ‰ä¼šèµ°åˆ°è¿™é‡Œ**

---

# ä¸‰ã€ä½ ç°åœ¨ç³»ç»Ÿé‡Œä¸€ä¸ªçœŸå®å†³ç­–ç¤ºä¾‹

## æ—¥å¿—å›æ”¾

```log
[PORTAL_AUTH] request user=testuser
[POLICY] user=testuser source=default policy=default
[AUTH][DENY] err=è¯¥è®¤è¯æ–¹å¼å°šæœªå¼€æ”¾
```

## å¯¹åº”æµç¨‹å›¾ä¸­çš„è·¯å¾„

```
Portal â†’ NAC
   â†“
FeatureFlag(pap) = false
   â†“
ç›´æ¥æ‹’ç»ï¼ˆä¸ä¼šå†çœ‹ policy / RADIUSï¼‰
```

---

# å››ã€è¿™å¼ å›¾åœ¨å·¥ç¨‹ä¸Šçš„ä»·å€¼

## 1ï¸âƒ£ æ’éšœä»·å€¼ï¼ˆéå¸¸é«˜ï¼‰

ä»¥åçœ‹åˆ°ä»»ä½•ï¼š

```log
[AUTH][DENY]
```

åªéœ€è¦é—®è‡ªå·±ä¸€å¥ï¼š

> **â€œæ˜¯åœ¨å“ªä¸€å±‚è¢« deny çš„ï¼Ÿâ€**

ç„¶åå¯¹ç…§æµç¨‹å›¾å³å¯ã€‚

---

## 2ï¸âƒ£ é˜²æ­¢é€»è¾‘è…åŒ–

è¿™å¼ å›¾æ˜ç¡®è§„å®šï¼š

* FeatureFlag ä¸è¯¥å†³å®š redirect
* Policy Override ä¸è¯¥å†³å®šèƒ½åŠ›æ˜¯å¦å¼€æ”¾
* Strategy ä¸è¯¥åšç­–ç•¥åˆ¤æ–­

ğŸ‘‰ **é˜²æ­¢æœªæ¥æŠŠé€»è¾‘å†™ä¹±**

---

## 3ï¸âƒ£ éå¸¸é€‚åˆæ‰©å±•

ä»¥ååŠ ï¼š

* `policy:mac:*`
* `policy:nas:*`
* `feature:portal:*`
* `feature:auth:*`

åªæ˜¯åœ¨å›¾ä¸ŠåŠ ä¸€ä¸ªåˆ†æ”¯ï¼Œè€Œä¸æ˜¯æ¨ç¿»é€»è¾‘ã€‚

---

# æ€»ç»“ä¸€å¥ï¼ˆæ¶æ„è¯„ä»·ï¼‰

å½“å‰çš„ç³»ç»Ÿå·²ç»ä¸æ˜¯â€œç™»å½•æµç¨‹â€ï¼Œè€Œæ˜¯ï¼š

> **ä¸€ä¸ªå…·å¤‡èƒ½åŠ›å¼€å…³ã€ç­–ç•¥åˆ†å±‚ã€ä¾‹å¤–å¤„ç†ã€å¯è¿ç»´æ€§çš„å‡†å…¥å†³ç­–å¼•æ“**

è¿™å¼ æµç¨‹å›¾ï¼Œæ­£æ˜¯å®ƒçš„**è®¾è®¡åˆåŒ**ã€‚
